<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>C&E – Panier</title>
<style>
  :root{
    --brand:#ff3a3a; --bg:#fff8f5; --ink:#333; --panel:#ffffff;
    --muted:#f4f4f4; --shadow:0 2px 10px rgba(0,0,0,.08);
    --border:#eee;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:1.6rem 1rem}
  header .wrap{max-width:1100px;margin:0 auto;display:flex;gap:1rem;align-items:center;justify-content:space-between}
  header a{color:#fff;text-decoration:none;font-weight:700}
  .wrap{max-width:1100px;margin:0 auto;padding:1rem}

  .panel{background:var(--panel);border-radius:16px;box-shadow:var(--shadow);padding:1rem}
  h1{margin:.2rem 0 0;font-size:1.4rem}
  .empty{
    text-align:center;padding:2rem 1rem;background:#fff;border:1px dashed #ffd2d2;border-radius:16px;color:#b60000
  }

  /* Liste des items */
  .cart-list{display:flex;flex-direction:column;gap:1rem;margin-top:1rem}
  .item{
    display:grid;grid-template-columns:1fr auto;gap:.8rem;align-items:center;
    border:1px solid var(--border);border-radius:14px;background:#fff;padding:.9rem;
  }
  .item-head{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
  .badge{padding:.25rem .6rem;border-radius:999px;background:#ffe3e3;color:#b60000;font-weight:700;font-size:.85rem}
  .meta{font-size:.95rem;color:#555}
  .meta b{color:#333}
  .list{margin:.4rem 0 0;padding:0 0 0 1rem;color:#444}
  .list li{margin:.15rem 0}

  .qty{display:flex;gap:.4rem;align-items:center}
  .qty button{
    width:34px;height:34px;border-radius:10px;border:1px solid #ffd2d2;background:#fff;color:var(--brand);
    font-weight:800;cursor:pointer
  }
  .qty input{
    width:46px;height:34px;text-align:center;border:1px solid var(--border);border-radius:10px
  }

  .actions{display:flex;gap:.6rem;flex-wrap:wrap}
  .btn{
    border:none;border-radius:12px;padding:.8rem 1.1rem;cursor:pointer;font-weight:700;box-shadow:var(--shadow)
  }
  .btn-primary{background:var(--brand);color:#fff}
  .btn-light{background:#fff;border:1px solid #ffd2d2;color:var(--brand)}
  .btn-ghost{background:#fff;border:1px solid var(--border);color:#333}
  .item-right{display:flex;flex-direction:column;gap:.6rem;align-items:flex-end}

  .summary{
    display:grid;grid-template-columns:1fr auto;gap:.6rem;padding:1rem;border-top:1px solid var(--border);margin-top:1rem
  }
  .summary .row{display:flex;gap:.5rem;justify-content:space-between}
  .summary .total{font-weight:800}
  .muted{color:#666}

  /* Petits libellés */
  .tiny{font-size:.85rem;color:#666}
  /* pastille sur le bouton caddie */
.fab-cart {
  position:fixed; right:18px; bottom:18px; z-index:20;
  background:var(--brand); border:none; color:#fff;
  width:62px; height:62px; border-radius:50%;
  box-shadow:0 8px 24px rgba(255,58,58,.35);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; position:relative;
}
.fab-cart img{ width:30px; height:30px; filter:invert(1) brightness(9); }
.fab-cart .badge {
  position:absolute; top:6px; right:6px;
  background:#fff; color:var(--brand);
  font-weight:700; font-size:.8rem;
  border-radius:999px; padding:2px 6px;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
}
  /* Etat désactivé/lock visuel pour les boutons */
.btn:disabled,
.btn.is-disabled{
  opacity:.55;
  cursor:not-allowed;
  filter:grayscale(1);
  box-shadow:none;
}
.btn-primary:disabled{ background:#d6d6d6; color:#888; border:1px solid #ddd; }

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div><a href="carte.html">Continuer les achats</a></div>
    <strong>Votre panier</strong>
    <div></div>
  </div>
</header>

<main class="wrap">
  <section class="panel">
    <h1>Récapitulatif</h1>

    <div id="cartEmpty" class="empty" style="display:none">
      Votre panier est vide pour le moment.<br>
      <div style="margin-top:.8rem">
        <a class="btn btn-primary" href="carte.html">Aller à la carte</a>
      </div>
    </div>

    <div id="cartList" class="cart-list" aria-live="polite"></div>

    <div id="cartSummary" class="summary" style="display:none">
      <div class="row"><span>Articles</span><span id="sumItems">0</span></div>
      <div class="row"><span>Estimation</span><span id="sumPrice">—</span></div>
      <div class="row total"><span>Total</span><span id="sumTotal">—</span></div>
    </div>

    <!-- Infos retrait / client -->
    <div class="panel" style="margin-top:1rem">
      <h2 style="margin-top:0">Infos de retrait</h2>
      <div style="display:grid;gap:.8rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div>
          <label class="tiny">Nom</label>
          <input id="chkName" type="text" placeholder="Votre nom" style="width:100%;padding:.6rem;border:1px solid #eee;border-radius:10px">
        </div>
        <div>
          <label class="tiny">Téléphone</label>
          <input id="chkPhone" type="tel" placeholder="06..." style="width:100%;padding:.6rem;border:1px solid #eee;border-radius:10px">
        </div>
        <div>
          <label class="tiny">Mode de retrait</label>
          <select id="chkMode" style="width:100%;padding:.6rem;border:1px solid #eee;border-radius:10px">
            <option value="magasin" selected>Retrait en magasin</option>
          </select>
        </div>
        <div>
  <label class="tiny">Horaire (aujourd’hui)</label>
  <select id="chkSlot" style="width:100%;padding:.6rem;border:1px solid #eee;border-radius:10px"></select>
</div>

      </div>
      <div style="margin-top:.6rem">
        <label class="tiny">Remarques (allergies, sauces, précisions...)</label>
        <textarea id="chkNote" rows="2" style="width:100%;padding:.6rem;border:1px solid #eee;border-radius:10px"></textarea>
      </div>
      <p class="tiny muted" style="margin:.4rem 0 0">Le paiement s’effectue en magasin.</p>
    </div>

    <div class="actions" id="cartActions" style="display:none;margin-top:1rem;justify-content:flex-end">
      <button class="btn btn-ghost" id="btnClear">Vider le panier</button>
      <a class="btn btn-light" href="carte.html">Ajouter d’autres produits</a>
      <button class="btn btn-primary" id="btnCheckout">Passer la commande</button>
    </div>

    <p class="tiny" style="margin-top:.8rem">
      Astuce : si vous avez ajouté un <b>Menu Poké + Smoothie</b>, les détails du poké (taille, base, ingrédients, protéines, sauce, toppings)
      et du smoothie sont affichés ci-dessous.
    </p>
  </section>
</main>

<script>
  const CART_KEY = 'ce-panier';

  const elList   = document.getElementById('cartList');
  const elEmpty  = document.getElementById('cartEmpty');
  const elSummary= document.getElementById('cartSummary');
  const elActions= document.getElementById('cartActions');
  const elSumItems = document.getElementById('sumItems');
  const elSumPrice = document.getElementById('sumPrice');
  const elSumTotal = document.getElementById('sumTotal');
const btnCheckout = document.getElementById('btnCheckout');

/** Verrouille le bouton pendant `ms` millisecondes */
function lockCheckout(ms = 5000){
  if (!btnCheckout) return;
  btnCheckout.disabled = true;
  btnCheckout.classList.add('is-disabled');
  // Déverrouille après ms millisecondes
  setTimeout(()=>{
    btnCheckout.disabled = false;
    btnCheckout.classList.remove('is-disabled');
  }, ms);
}

  function loadCart(){
    try{
      const raw = localStorage.getItem(CART_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }
  function saveCart(items){
    localStorage.setItem(CART_KEY, JSON.stringify(items));
  }

  function computeTotals(items){
    let count = 0;
    let hasPrice = items.some(i => typeof i.price === 'number');
    let total = 0;
    for(const it of items){
      const q = Number(it.qty || 1);
      count += q;
      if(typeof it.price === 'number') total += it.price * q;
    }
    return {count, hasPrice, total};
  }

  function formatPrice(v){
    return new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(v);
  }

  function itemTitle(it){
    if(it.type === 'menu') return 'Menu Poké + Smoothie';
    if(it.type === 'poke' && it.size) return `Poké ${it.size}`;
    return it.title || 'Article';
  }

  function itemMeta(it){
    if(it.type === 'menu' || it.type === 'poke'){
      const parts = [];
      if(it.poke_size || it.size) parts.push(`<b>Poké ${it.poke_size || it.size}</b>`);
      if(it.base) parts.push(`Base : ${it.base}`);
      if(Array.isArray(it.ingredients) && it.ingredients.length) parts.push(`Ingrédients : ${it.ingredients.join(', ')}`);
      if(Array.isArray(it.proteines) && it.proteines.length) parts.push(`Protéine(s) : ${it.proteines.join(', ')}`);
      if(it.sauce) parts.push(`Sauce : ${it.sauce}`);
      if(Array.isArray(it.toppings) && it.toppings.length) parts.push(`Toppings : ${it.toppings.join(', ')}`);
      if(it.smoothie) parts.push(`<b>Smoothie</b> : ${it.smoothie}`);
      return parts.join(' • ');
    }
    const p = [];
    if(it.variant) p.push(it.variant);
    if(it.note) p.push(it.note);
    return p.join(' • ');
  }

  function render(){
    const items = loadCart();
    elList.innerHTML = '';

    if(!items.length){
      elEmpty.style.display = '';
      elSummary.style.display = 'none';
      elActions.style.display = 'none';
      updateBadge(0);
      return;
    }
    elEmpty.style.display = 'none';
    elSummary.style.display = '';
    elActions.style.display = '';

    items.forEach((it, idx) => {
      const div = document.createElement('div');
      div.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `
        <div class="item-head">
          <span class="badge">${it.type || 'article'}</span>
          <strong>${itemTitle(it)}</strong>
        </div>
        <div class="meta">${itemMeta(it) || ''}</div>
      `;

      const right = document.createElement('div');
      right.className = 'item-right';

      const priceLine = document.createElement('div');
      priceLine.className = 'muted';
      priceLine.textContent = (typeof it.price === 'number')
        ? 'Prix unitaire : ' + formatPrice(it.price)
        : 'Prix : —';

      const qty = document.createElement('div');
      qty.className = 'qty';
      qty.innerHTML = `
        <button aria-label="Diminuer" data-act="dec">−</button>
        <input type="number" min="1" step="1" value="${Number(it.qty||1)}" aria-label="Quantité">
        <button aria-label="Augmenter" data-act="inc">+</button>
      `;

      const act = document.createElement('div');
      act.className = 'actions';
      act.innerHTML = `<button class="btn btn-light" data-act="remove">Supprimer</button>`;

      right.appendChild(priceLine);
      right.appendChild(qty);
      right.appendChild(act);

      div.appendChild(left);
      div.appendChild(right);
      elList.appendChild(div);

      const input = qty.querySelector('input');
      const btnInc = qty.querySelector('button[data-act="inc"]');
      const btnDec = qty.querySelector('button[data-act="dec"]');
      const btnRemove = act.querySelector('button[data-act="remove"]');

      btnInc.addEventListener('click', ()=>{
        const arr = loadCart();
        arr[idx].qty = Number(arr[idx].qty||1) + 1;
        saveCart(arr); render();
      });
      btnDec.addEventListener('click', ()=>{
        const arr = loadCart();
        arr[idx].qty = Math.max(1, Number(arr[idx].qty||1) - 1);
        saveCart(arr); render();
      });
      input.addEventListener('change', ()=>{
        let q = parseInt(input.value, 10);
        if(isNaN(q) || q<1) q = 1;
        const arr = loadCart(); arr[idx].qty = q; saveCart(arr); render();
      });
      btnRemove.addEventListener('click', ()=>{
        const arr = loadCart(); arr.splice(idx,1); saveCart(arr); render();
      });
    });

    const totals = computeTotals(items);
    elSumItems.textContent = totals.count;
    if(totals.hasPrice){
      elSumPrice.textContent = formatPrice(totals.total);
      elSumTotal.textContent = formatPrice(totals.total);
    }else{
      elSumPrice.textContent = '—';
      elSumTotal.textContent = '—';
    }

    updateBadge(totals.count);
  }

  function updateBadge(count){
    const badge = document.getElementById('cartBadge');
    if(badge) badge.textContent = count;
  }

  document.getElementById('btnClear').addEventListener('click', ()=>{
    if(confirm('Vider complètement le panier ?')){
      localStorage.setItem(CART_KEY, JSON.stringify([]));
      render();
    }
  });

  // ---- Checkout ----
  function serializeItem(it){
    const out = {
      type: it.type,
      title: it.title || (it.type === 'menu' ? `Menu Poké ${it.poke_size} + Smoothie` : (it.size ? `Poké ${it.size}` : it.type)),
      qty: Number(it.qty||1),
      price: typeof it.price === 'number' ? it.price : null
    };
    if(it.type === 'poke' || it.type === 'menu'){
      out.details = {
        poke_size: it.poke_size || it.size || null,
        base: it.base || null,
        ingredients: Array.isArray(it.ingredients)? it.ingredients : [],
        proteines: Array.isArray(it.proteines)? it.proteines : [],
        sauce: it.sauce || null,
        toppings: Array.isArray(it.toppings)? it.toppings : [],
        smoothie: it.smoothie || null
      };
    }
    return out;
  }
function buildTimeSlots(start="11:30", end="21:30", stepMinutes=30){
  const [sH, sM] = start.split(':').map(Number);
  const [eH, eM] = end.split(':').map(Number);
  const slots = [];
  const d = new Date(); d.setHours(sH, sM, 0, 0);
  const stop = new Date(); stop.setHours(eH, eM, 0, 0);

  while (d <= stop) {
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    slots.push(`${hh}:${mm}`);
    d.setMinutes(d.getMinutes() + stepMinutes);
  }
  return slots;
}

function populateSlotSelect(selectId='chkSlot'){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  sel.innerHTML = '';

  const now = new Date();
  const allSlots = buildTimeSlots("11:30","21:30",30);

  // 1) on ne garde que les créneaux ≥ maintenant
  allSlots.forEach(t=>{
    const [h,m] = t.split(':').map(Number);
    const slotDate = new Date();
    slotDate.setHours(h, m, 0, 0);
    if (slotDate >= now) {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      sel.appendChild(opt);
    }
  });

  // 2) si plus aucun créneau avenir aujourd’hui, on propose toute la plage (repli)
  if (sel.options.length === 0) {
    allSlots.forEach(t=>{
      const opt = document.createElement('option');
      opt.value = t; opt.textContent = t;
      sel.appendChild(opt);
    });
  }
}

  document.getElementById('btnCheckout').addEventListener('click', async ()=>{
      // --- Début ajouté : anti-double-clic immédiat + verrou 5s ---
  if (btnCheckout.disabled) return;      // ignore si déjà verrouillé
  lockCheckout(5000);                     // grise et bloque 5 secondes
  // --- Fin ajouté ---

    const items = loadCart();
    if(items.length === 0){
      alert('Votre panier est vide.');
      return;
    }

    const name  = (document.getElementById('chkName')?.value || '').trim();
    const phone = (document.getElementById('chkPhone')?.value || '').trim();
    const mode  = document.getElementById('chkMode')?.value || 'magasin';
    const slot  = document.getElementById('chkSlot')?.value || '';
    const note  = (document.getElementById('chkNote')?.value || '').trim();

    if(!name || !phone){
      alert('Merci de renseigner au minimum votre nom et téléphone.');
      return;
    }

    const totals = computeTotals(items);
    const payload = {
      created_at: new Date().toLocaleString('fr-FR'),
      client: { name, phone },
      pickup: { mode, slot },
      note,
      items: items.map(serializeItem),
      total: totals.total
    };

    try{
      const res = await fetch('/.netlify/functions/proxy', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const json = await res.json();

      if(!res.ok){
        console.error('Proxy error:', json);
        alert('Erreur lors de l’envoi de la commande.');
        return;
      }

      alert('✅ Commande envoyée ! Paiement en magasin.\nMerci 🙂');
      localStorage.setItem(CART_KEY, JSON.stringify([]));
      render();
    }catch(e){
      console.error(e);
      alert('❌ Erreur réseau. Réessaie dans un instant.');
    }
  });

  // Init
  if(!localStorage.getItem(CART_KEY)) localStorage.setItem(CART_KEY, JSON.stringify([]));
  render();
  // Init existante
if(!localStorage.getItem(CART_KEY)) localStorage.setItem(CART_KEY, JSON.stringify([]));
render();
populateSlotSelect();

// Si l’utilisateur revient sur l’onglet plus tard, on rafraîchit la liste
document.addEventListener('visibilitychange', ()=>{
  if (!document.hidden) populateSlotSelect();
});

</script>

</body>
</html>
